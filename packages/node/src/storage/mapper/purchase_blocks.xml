<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="purchase_blocks">

    <insert id="postBlock">
        INSERT INTO purchase_blocks
        (
            "height"                ,
            "curBlock"              ,
            "prevBlock"             ,
            "merkleRoot"            ,
            "timestamp"
        )
        VALUES
            (
                ${height}           ,
                #{curBlock}         ,
                #{prevBlock}        ,
                #{merkleRoot}       ,
                ${timestamp}
            )
            ON CONFLICT ("height")  DO NOTHING;
    </insert>

    <insert id="postTransaction">
        INSERT INTO purchase_transactions
        (
            "purchaseId"        ,
            "timestamp"         ,
            "height"            ,
            "hash"              ,
            "contents"
        )
        VALUES
            (
                #{purchaseId}   ,
                ${timestamp}    ,
                ${height}       ,
                #{hash}         ,
                #{contents}
            )
            ON CONFLICT ("purchaseId")  DO NOTHING;
    </insert>

    <update id="canceledTransaction">
        UPDATE purchase_transactions
        SET
            "canceled" = 'Y'
        WHERE "purchaseId" = #{purchaseId}
    </update>

    <select id="getLatestHeight">
        SELECT coalesce(max(height), 0) as height FROM purchase_blocks;
    </select>

    <select id="getTransaction">
        SELECT * FROM purchase_transactions
        WHERE "timestamp" <![CDATA[<]]> ${timestamp}
            AND "canceled" = 'N'
            AND "stored" = 'N';
    </select>

    <update id="storedTransaction">
        UPDATE purchase_transactions
        SET
            "stored" = 'Y'
        WHERE "purchaseId" = #{purchaseId}
    </update>

</mapper>
